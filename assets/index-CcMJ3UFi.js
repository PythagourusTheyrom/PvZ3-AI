(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const h of s)if(h.type==="childList")for(const a of h.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const h={};return s.integrity&&(h.integrity=s.integrity),s.referrerPolicy&&(h.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?h.credentials="include":s.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function i(s){if(s.ep)return;s.ep=!0;const h=t(s);fetch(s.href,h)}})();class y{constructor(e,t=5,i=9,s=100,h=200,a=100){this.game=e,this.rows=t,this.cols=i,this.cellSize=s,this.startX=h,this.startY=a,this.cells=[];for(let l=0;l<t;l++){const u=[];for(let f=0;f<i;f++)u.push({row:l,col:f,x:h+f*s,y:a+l*s,plant:null});this.cells.push(u)}}getGridPos(e,t){if(e<this.startX||e>=this.startX+this.cols*this.cellSize||t<this.startY||t>=this.startY+this.rows*this.cellSize)return null;const i=Math.floor((e-this.startX)/this.cellSize);return{row:Math.floor((t-this.startY)/this.cellSize),col:i}}getCell(e,t){return e>=0&&e<this.rows&&t>=0&&t<this.cols?this.cells[e][t]:null}draw(e){e.lineWidth=2,e.strokeStyle="rgba(0, 0, 0, 0.2)";for(let t=0;t<this.rows;t++)for(let i=0;i<this.cols;i++){const s=this.cells[t][i];(t+i)%2===0&&(e.fillStyle="rgba(0, 0, 0, 0.05)",e.fillRect(s.x,s.y,this.cellSize,this.cellSize)),s.plant&&s.plant.draw(e)}}}class S{constructor(e){this.game=e,this.canvas=e.canvas,this.mouseX=0,this.mouseY=0,this.canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),this.canvas.addEventListener("mousedown",t=>this.onMouseDown(t))}getMousePos(e){const t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}onMouseMove(e){const t=this.getMousePos(e);this.mouseX=t.x,this.mouseY=t.y}onMouseDown(e){if(this.game.state!=="PLAYING")return;const t=this.getMousePos(e);let i=!1;for(let s=this.game.suns.length-1;s>=0;s--){const h=this.game.suns[s];if(h.isMouseOver(t.x,t.y)){this.game.collectSun(h),i=!0;break}}i||this.game.onClick(t.x,t.y)}}class w{constructor(e,t,i){this.game=e,this.x=t,this.y=i,this.width=80,this.height=80,this.markedForDeletion=!1}update(e){}draw(e){e.strokeStyle="red",e.strokeRect(this.x,this.y,this.width,this.height)}}class v extends w{constructor(e,t,i,s="normal"){super(e,t,i),this.width=20,this.height=20,this.speed=.4,this.damage=25,this.markedForDeletion=!1,this.type=s,this.freeze=s==="frozen"}update(e){this.x+=this.speed*e,this.x>this.game.width&&(this.markedForDeletion=!0)}draw(e){this.type==="frozen"?e.fillStyle="#60a5fa":e.fillStyle="#4ade80",e.beginPath(),e.arc(this.x+this.width/2,this.y+this.height/2,10,0,Math.PI*2),e.fill(),this.type==="frozen"?e.fillStyle="#bfdbfe":e.fillStyle="#86efac",e.beginPath(),e.arc(this.x+this.width/2-3,this.y+this.height/2-3,3,0,Math.PI*2),e.fill()}}const m={images:{},loadImage(o,e){return new Promise((t,i)=>{if(this.images[o]){t(this.images[o]);return}const s=new Image;s.onload=()=>{this.images[o]=s,t(s)},s.onerror=h=>i(h),s.src=e})},getImage(o){return this.images[o]},async loadAll(o){const e=[];for(const[t,i]of Object.entries(o))e.push(this.loadImage(t,i));return Promise.all(e)}};class k extends w{constructor(e,t,i,s){super(e,t,i),this.type=s,this.health=100,this.timer=0,this.shootInterval=1500,this.color=s==="peashooter"?"#4ade80":s==="sunflower"?"#facc15":s==="wallnut"?"#a16207":s==="cherrybomb"?"#dc2626":s==="snowpea"?"#60a5fa":"#fff",this.type==="wallnut"&&(this.health=400),this.idleTime=0}update(e){this.timer+=e,this.idleTime+=e*.002,this.type==="peashooter"?this.timer>this.shootInterval&&(this.timer=0,this.shoot()):this.type==="snowpea"?this.timer>this.shootInterval&&(this.timer=0,this.shoot("frozen")):this.type==="sunflower"?this.timer>5e3&&(this.timer=0,this.game.spawnSun(this.x+10,this.y+10,this.y+40)):this.type==="cherrybomb"&&this.timer>2e3&&this.explode()}shoot(e="normal"){this.game.projectiles.push(new v(this.game,this.x+60,this.y+30,e))}explode(){this.markedForDeletion=!0,this.game.createExplosion(this.x+this.width/2,this.y+this.height/2)}draw(e){this.type==="peashooter"?this.drawPeashooter(e):this.type==="snowpea"?this.drawSnowPea(e):this.type==="cherrybomb"?this.drawCherryBomb(e):(e.fillStyle=this.color,e.beginPath(),e.arc(this.x+this.width/2,this.y+this.height/2,30,0,Math.PI*2),e.fill(),e.fillStyle="black",e.beginPath(),e.arc(this.x+this.width/2+10,this.y+this.height/2-10,4,0,Math.PI*2),e.fill())}drawPeashooter(e){const t=m.getImage("peashooter_head"),i=m.getImage("peashooter_leaf");if(!t||!i)return;const s=this.x+this.width/2,h=this.y+this.height/2+20,a=.08;e.save(),e.translate(s,h),e.save(),e.scale(a,a),e.drawImage(i,-409,-850),e.save(),e.scale(-1,1),e.drawImage(i,-409,-850),e.restore(),e.restore();const l=Math.sin(this.idleTime)*5;e.save(),e.translate(0,-30+l),e.scale(a,a),e.drawImage(t,-150,-700),e.restore(),e.restore()}drawSnowPea(e){const t=m.getImage("snow_pea");t&&(e.save(),e.drawImage(t,this.x+10,this.y+10,this.width-20,this.height-20),e.restore())}drawCherryBomb(e){const t=m.getImage("cherry_bomb");if(!t)return;const i=1+Math.sin(this.timer*.01)*.1;e.save(),e.translate(this.x+this.width/2,this.y+this.height/2),e.scale(i,i),e.drawImage(t,-40,-40,80,80),e.restore()}}class g{constructor(e,t,i,s,h=0,a=0){this.name=e,this.image=t,this.x=i,this.y=s,this.pivotX=h,this.pivotY=a,this.rotation=0,this.scaleX=1,this.scaleY=1,this.children=[],this.parent=null}addChild(e){e.parent=this,this.children.push(e)}update(e){}draw(e,t){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation),e.scale(this.scaleX,this.scaleY),this.image&&e.drawImage(this.image,-this.pivotX,-this.pivotY),this.children.forEach(i=>i.draw(e)),e.restore()}}class I{constructor(e,t){this.x=e,this.y=t,this.root=null,this.bones=new Map}setRoot(e){this.root=e,this.addBoneToMap(e)}addBoneToMap(e){this.bones.set(e.name,e),e.children.forEach(t=>this.addBoneToMap(t))}getBone(e){return this.bones.get(e)}update(e){}draw(e){e.save(),e.translate(this.x,this.y),this.root&&this.root.draw(e),e.restore()}}class P extends w{constructor(e,t,i="basic"){super(e,1024,t),this.type=i,this.health=100,this.speed=.02,this.damage=.5,this.isEating=!1,this.targetPlant=null,this.animTime=0,this.walkSpeed=.005,this.slowTimer=0,this.currentSpeed=this.speed,this.initSkeleton()}applySlow(e){this.slowTimer=e}initSkeleton(){this.skeleton=new I(0,0);const e=m.getImage("zombie_head"),t=m.getImage("zombie_body"),i=m.getImage("zombie_arm"),s=m.getImage("zombie_leg"),h=.1;this.torso=new g("torso",t,0,0,343,458),this.torso.scaleX=h,this.torso.scaleY=h,this.skeleton.setRoot(this.torso),this.head=new g("head",e,0,-400,386,750),this.torso.addChild(this.head),this.lArm=new g("lArm",i,-150,-350,200,100),this.rArm=new g("rArm",i,150,-350,200,100),this.torso.addChild(this.lArm),this.torso.addChild(this.rArm),this.lLeg=new g("lLeg",s,-100,350,400,50),this.rLeg=new g("rLeg",s,100,350,400,50),this.torso.addChild(this.lLeg),this.torso.addChild(this.rLeg)}update(e){this.slowTimer>0?(this.slowTimer-=e,this.currentSpeed=this.speed*.5):this.currentSpeed=this.speed,this.isEating?(this.targetPlant&&!this.targetPlant.markedForDeletion?(this.targetPlant.health-=this.damage,this.targetPlant.health<=0&&(this.targetPlant.markedForDeletion=!0,this.isEating=!1,this.targetPlant=null)):(this.isEating=!1,this.targetPlant=null),this.animateEat(e)):(this.x-=this.currentSpeed*e,this.animateWalk(e)),this.x<-50&&this.game.gameOver()}animateWalk(e){this.animTime+=e*this.walkSpeed,this.head.rotation=Math.sin(this.animTime)*.1,this.lArm.rotation=Math.sin(this.animTime)*.5,this.rArm.rotation=Math.sin(this.animTime+Math.PI)*.5,this.lLeg.rotation=Math.sin(this.animTime)*.6,this.rLeg.rotation=Math.sin(this.animTime+Math.PI)*.6}animateEat(e){this.animTime+=e*.01,this.head.rotation=Math.abs(Math.sin(this.animTime*10))*.2,this.lArm.rotation=1+Math.sin(this.animTime*10)*.1}draw(e){this.skeleton.x=this.x+this.width/2,this.skeleton.y=this.y+this.height-10,this.skeleton.draw(e),this.slowTimer>0&&(e.save(),e.fillStyle="rgba(100, 149, 237, 0.4)",e.fillRect(this.x,this.y,this.width,this.height),e.restore())}}class z{constructor(e,t,i,s){this.game=e,this.x=t,this.y=i,this.toY=s!==void 0?s:i,this.value=25,this.width=50,this.height=50,this.markedForDeletion=!1,this.life=0,this.maxLife=1e4,this.fallSpeed=.05,this.opacity=1}update(e){this.life+=e,this.life>this.maxLife&&(this.markedForDeletion=!0),this.y<this.toY&&(this.y+=this.fallSpeed*e),this.life>this.maxLife-1e3&&(this.opacity=(this.maxLife-this.life)/1e3)}draw(e){e.save(),e.globalAlpha=this.opacity,e.fillStyle="#facc15",e.shadowColor="#fef08a",e.shadowBlur=20,e.beginPath(),e.arc(this.x+this.width/2,this.y+this.height/2,20,0,Math.PI*2),e.fill(),e.strokeStyle="#fde047",e.lineWidth=2,e.globalAlpha=this.opacity*.8;for(let t=0;t<8;t++){const i=Date.now()/1e3+t*Math.PI/4,s=this.x+this.width/2,h=this.y+this.height/2;e.beginPath(),e.moveTo(s+Math.cos(i)*22,h+Math.sin(i)*22),e.lineTo(s+Math.cos(i)*35,h+Math.sin(i)*35),e.stroke()}e.restore()}isMouseOver(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}}class E{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.width=e.width,this.height=e.height,this.lastTime=0,this.loop=this.loop.bind(this),this.state="MENU",this.level=1,this.zombiesToSpawn=10,this.zombiesSpawned=0,this.zombiesKilled=0,this.sun=100,this.grid=new y(this),this.input=new S(this),this.selectedPlant="peashooter",this.zombies=[],this.projectiles=[],this.suns=[],this.skySunTimer=0,this.skySunInterval=1e4,this.zombieSpawnTimer=0,this.zombieSpawnInterval=5e3}reset(){this.state="PLAYING",this.sun=100,this.zombies=[],this.projectiles=[],this.suns=[],this.grid=new y(this),this.zombiesSpawned=0,this.zombiesKilled=0,this.zombieSpawnTimer=0,this.zombiesToSpawn=10+this.level*2,document.querySelectorAll(".screen").forEach(e=>e.classList.add("hidden")),document.getElementById("sun-display").innerText=this.sun}gameOver(){this.state="GAME_OVER",document.getElementById("game-over-screen").classList.remove("hidden")}levelComplete(){this.state="LEVEL_COMPLETE",document.getElementById("level-complete-screen").classList.remove("hidden")}start(){this.state="PLAYING",this.lastTime=performance.now(),requestAnimationFrame(this.loop)}onClick(e,t){const i=this.grid.getGridPos(e,t);if(i){const s=this.grid.getCell(i.row,i.col);if(s&&!s.plant){let h=0;this.selectedPlant==="peashooter"?h=100:this.selectedPlant==="sunflower"||this.selectedPlant==="wallnut"?h=50:this.selectedPlant==="cherrybomb"?h=150:this.selectedPlant==="snowpea"&&(h=175),this.sun>=h&&(this.sun-=h,s.plant=new k(this,s.x,s.y,this.selectedPlant))}}}loop(e){const t=e-this.lastTime;this.lastTime=e,this.state==="PLAYING"&&(this.update(t),this.draw()),requestAnimationFrame(this.loop)}update(e){for(let i=0;i<this.grid.rows;i++)for(let s=0;s<this.grid.cols;s++){const h=this.grid.cells[i][s];h.plant&&(h.plant.markedForDeletion?h.plant=null:h.plant.update(e))}if(this.zombieSpawnTimer+=e,this.zombieSpawnTimer>this.zombieSpawnInterval&&this.zombiesSpawned<this.zombiesToSpawn){this.zombieSpawnTimer=0;const i=Math.floor(Math.random()*this.grid.rows),s=this.grid.startY+i*this.grid.cellSize+10;this.zombies.push(new P(this,s)),this.zombiesSpawned++,this.zombieSpawnInterval>1e3&&(this.zombieSpawnInterval-=50)}else this.zombiesSpawned>=this.zombiesToSpawn&&this.zombies.length===0&&this.levelComplete();this.zombies.forEach(i=>i.update(e)),this.projectiles.forEach(i=>i.update(e)),this.suns.forEach(i=>i.update(e)),this.skySunTimer+=e,this.skySunTimer>this.skySunInterval&&(this.skySunTimer=0,this.spawnSun(Math.random()*(this.width-50)+25,-50,Math.random()*(this.height-200)+100)),this.checkCollisions(),this.zombies=this.zombies.filter(i=>!i.markedForDeletion),this.projectiles=this.projectiles.filter(i=>!i.markedForDeletion),this.suns=this.suns.filter(i=>!i.markedForDeletion);const t=document.getElementById("sun-display");t&&(t.innerText=Math.floor(this.sun))}spawnSun(e,t,i){this.suns.push(new z(this,e,t,i))}collectSun(e){this.sun+=e.value,e.markedForDeletion=!0}createExplosion(e,t){this.zombies.forEach(s=>{Math.hypot(s.x+s.width/2-e,s.y+s.height/2-t)<150&&(s.health-=1800,s.health<=0&&(s.markedForDeletion=!0,this.sun+=10))})}checkCollisions(){for(const e of this.projectiles)for(const t of this.zombies)!e.markedForDeletion&&!t.markedForDeletion&&this.checkCollision(e,t)&&(t.health-=e.damage,e.markedForDeletion=!0,e.freeze&&t.applySlow(3e3),t.health<=0&&(t.markedForDeletion=!0,this.sun+=10));for(const e of this.zombies){if(e.markedForDeletion)continue;let t=!1;for(let i=0;i<this.grid.rows;i++){for(let s=0;s<this.grid.cols;s++){const h=this.grid.cells[i][s];if(h.plant&&!h.plant.markedForDeletion&&this.checkCollision(e,h.plant)){e.isEating=!0,e.targetPlant=h.plant,t=!0;break}}if(t)break}}}checkCollision(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}draw(){this.ctx.clearRect(0,0,this.width,this.height);const e=m.getImage("background");e?this.ctx.drawImage(e,0,0,this.width,this.height):(this.ctx.fillStyle="#166534",this.ctx.fillRect(0,0,this.width,this.height)),this.grid.draw(this.ctx),this.zombies.forEach(t=>t.draw(this.ctx)),this.projectiles.forEach(t=>t.draw(this.ctx)),this.suns.forEach(t=>t.draw(this.ctx))}}document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("game-canvas"),e=document.getElementById("start-screen"),t=document.getElementById("start-btn"),i=document.getElementById("ui-layer");if(o){const s=new E(o);console.log("PvZ 3 Game Initialized");const h={zombie_head:"assets/zombie_head.png",zombie_body:"assets/zombie_body.png",zombie_arm:"assets/zombie_arm.png",zombie_leg:"assets/zombie_leg.png",peashooter_head:"assets/peashooter_head.png",peashooter_leaf:"assets/peashooter_leaf.png",cherry_bomb:"assets/cherry_bomb.png",snow_pea:"assets/snow_pea.png",background:"assets/background.png"},a=document.getElementById("seed-selection-screen"),l=document.getElementById("lets-rock-btn");if(t&&e&&i&&a){console.log("Loading assets..."),t.disabled=!0,t.innerText="Loading...",m.loadAll(h).then(()=>{console.log("Assets loaded!"),t.disabled=!1,t.innerText="Play Now"}).catch(d=>{console.error("Failed to load assets",d),t.innerText="Error Loading"}),t.addEventListener("click",()=>{e.style.display="none",a.style.display="flex",a.classList.remove("hidden")});const c=new Set;document.querySelectorAll(".seed-card").forEach(d=>{d.addEventListener("click",()=>{const r=d.dataset.plant;c.has(r)?(c.delete(r),d.classList.remove("selected")):c.size<5&&(c.add(r),d.classList.add("selected")),c.size>0&&l?l.classList.remove("disabled"):l&&l.classList.add("disabled")})}),l&&l.addEventListener("click",()=>{if(c.size===0)return;const d=document.getElementById("seed-bar");d&&(d.innerHTML="",c.forEach(r=>{const n=document.createElement("div");n.className="seed-packet",n.dataset.plant=r;let p=50;r==="peashooter"?p=100:r==="cherrybomb"?p=150:r==="snowpea"&&(p=175),n.innerHTML=`<div class="seed-cost">${p}</div>`,r==="peashooter"&&(n.style.backgroundColor="#4ade80"),r==="sunflower"&&(n.style.backgroundColor="#facc15"),r==="wallnut"&&(n.style.backgroundColor="#a16207"),r==="cherrybomb"&&(n.style.backgroundColor="#dc2626"),r==="snowpea"&&(n.style.backgroundColor="#60a5fa"),n.addEventListener("click",()=>{s.selectedPlant=r,document.querySelectorAll(".seed-packet").forEach(b=>b.style.border="2px solid var(--glass-border)"),n.style.border="2px solid var(--primary)"}),d.appendChild(n)})),a.style.display="none",i.style.display="block",c.size>0&&(s.selectedPlant=Array.from(c)[0]),s.start(),console.log("PvZ 3 Game Started")})}const u=document.getElementById("restart-btn");u&&u.addEventListener("click",()=>{s.reset(),s.start()});const f=document.getElementById("next-level-btn");f&&f.addEventListener("click",()=>{s.level++,s.reset(),s.start()})}else console.error("Canvas element not found!")});
